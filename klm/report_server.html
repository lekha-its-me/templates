<%
if(Request.Form.HasProperty('date')) {
	var date = String(Request.Form.date);
	var auditorysArr = [];
	var doc = [];
	var list = [];
	var paDocs =[];
	var overall = 0;
	var pasCount = 0;
	var totalOverall = 0;
	var result = [];

	var assessmentList = XQuery("for $elem in assessment_appraises where contains($elem/code, 'kln_"+date+"') return $elem");

	for(assessm in assessmentList) {
		list.push(assessm.id);
		colls = OpenDoc(UrlFromDocID(Int(assessm.id))).TopElem.auditorys;

		for(coll in colls) {
			doc.push(coll.person_id);
		}
	}
	var assList = list.join(',');

	var arr = ArraySelectDistinct(doc);
	arr = arr.join(',');
	auditorysArr = ArraySort((XQuery("for $elem in collaborators where MatchSome($elem/id, "+arr+") return $elem")), 'fullname', '+');

	for(item in auditorysArr) {
		paDocs = XQuery("for $elem in pas where MatchSome($elem/assessment_appraise_id, "+assList+") and $elem/person_id="+Int(item.id)+" return $elem");

		for(pa in paDocs) {
			_doc = OpenDoc(UrlFromDocID(pa.id));
			overall+=Int(_doc.TopElem.overall);
			pasCount++;
		}
		if(pasCount>0) {
			totalOverall = overall / pasCount;
		}
		result.push({person: String(item.fullname), overall: String(totalOverall)});
		overall = 0;
		pasCount = 0;
		totalOverall = 0;
		paDocs = [];
		
	}
	var obj = tools.object_to_text(result, 'json');
	Response.Write(obj);
}

if(Request.Form.HasProperty('date_from')&&Request.Form.HasProperty('date_to')) {
	var date_from = Request.Form.date_from + '-01';
	var date_to = Request.Form.date_to + '-10';

	var auditorysArr = [];
	var doc = [];
	var list = [];
	var paDocs =[];
	var overall = 0;
	var pasCount = 0;
	var totalOverall = 0;
	var result = [];
	var marksArr = [];

	var assessmentList = XQuery("for $elem in assessment_appraises where contains($elem/code, 'kln_') and $elem/start_date>='"+date_from+"' and $elem/start_date<='"+date_to+"' return $elem");
	
	for(assessm in assessmentList) {
		list.push(assessm.id);
		colls = OpenDoc(UrlFromDocID(Int(assessm.id))).TopElem.auditorys;

		for(coll in colls) {
			doc.push(coll.person_id);
		}
	}
	var assList = list.join(',');

	var arr = ArraySelectDistinct(doc);
	arr = arr.join(',');
	auditorysArr = ArraySort((XQuery("for $elem in collaborators where MatchSome($elem/id, "+arr+") return $elem")), 'fullname', '+');
	for(item in auditorysArr) {
		paDocs = XQuery("for $elem in pas where MatchSome($elem/assessment_appraise_id, "+assList+") and $elem/person_id="+Int(item.id)+" order by ForeignElem($elem/assessment_appraise_id)/start_date return $elem");

		for(pa in paDocs) {
			_doc = OpenDoc(UrlFromDocID(pa.id));
			overall+=Int(_doc.TopElem.overall);
			pasCount++;
			marksArr.push({month: String(_doc.TopElem.assessment_appraise_id.ForeignElem.start_date), overall: String(_doc.TopElem.overall)});
		}
		if(pasCount>0) {
			totalOverall = overall / pasCount;
		}
		result.push({person: String(item.fullname), id:String(item.id), marks: marksArr, overall: String(totalOverall)});
		overall = 0;
		pasCount = 0;
		totalOverall = 0;
		paDocs = [];
		marksArr = [];
		
	}
	var obj = tools.object_to_text(result, 'json');
	Response.Write(obj);
}
%>