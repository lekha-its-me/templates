<script type="text/javascript">
$(document).ready(function(e) {
	$('span.wb-table-day-li').hover(
		function()
		{
			$('div#t_' + $(this).attr('id')).show();
		},
		function()
		{
			$('div#t_' + $(this).attr('id')).hide();
		}
	);
	$('a#wb_link_active').click(
		function()
		{
			_text = ['Только активные', 'Показать всех'];
			if($('a#wb_link_active').html() == _text[0])
			{
				$('a#wb_link_active').html(_text[1])
				$('div.wb-finish-learning').slideUp(50);
			}
			else
			{
				$('a#wb_link_active').html(_text[0])
				$('div.wb-finish-learning').slideDown(50);
			}
		}
	);
	$('a#wb_link_shops').click(
		function()
		{
			$('div#wb_now_shop').hide();
			$('div#wb_shop_select').show();
		}
	);
});

</script>
<style type="text/css">
/*-ТОП-*/
div.wb-block			{ width:1195px; height:auto; }
div.wb-head-line-a		{ width:100%; height:30px; background:url(my_template/img/grey_bg_30px.png); }
div.wb-head-line-b		{ width:1193px; height:15px; padding:7px 0px 7px 0px; border-bottom:#EEEEEE 1px solid; border-left:#DDDDDD 1px solid; border-right:#DDDDDD 1px solid; font-family:Tahoma, Geneva, sans-serif; font-family:12px;  }
span.wb-head-shop-name	{ display:block; height:16px; padding:7px 0px 7px 10px; font-family: Tahoma, Geneva, sans-serif; font-size: 14px; color:#444444; }
span.wb-head-count		{ display:block; float:left; padding-left:10px; color:#555555; }
a.wb-head-view			{ display:block; float:right; margin:0px 15px 0px 0px; color:#4682B4; text-decoration:none; cursor:pointer; }
a.wb-head-view:hover	{ text-decoration:underline; }
/*-ТЕЛО-*/
div.wb-body				{ width:1193px; height:auto; border:#DDDDDD 1px solid; border-top-width:0; }
span.wb-null-result		{ display:block; width:100%; height:auto; padding:100px 0px 100px 0px; text-align:center; font-family:Tahoma, Geneva, sans-serif; font-size:13px; color:#888888; }
div.wb-shop-select		{ display:none; background:#F9F9F9; }
/*-ЗАГОЛОВОК-*/
div.wb-table-head		{ width:1905px; height:auto; border-bottom:#EEEEEE 1px solid; background:#FFFAFA; }
span.wb-table-head-li	{ display:block; float:left; height:14px; padding:18px 0px 18px 0px; border-right:#EEEEEE 1px solid; text-align:center; font-family:Arial, Helvetica, sans-serif; font-size:13px; color:#555555; }
span.wb-table-head-li-b	{ display:block; float:left; width:546px; height:50px; background:#EEEEE0; }
div.wb-table-head-day-head	{ width:100%; height:13px; padding:5px 0px 4px 0px; border-bottom:#AAAAAA 1px solid; text-align:center; font-family:Tahoma, Geneva, sans-serif; font-size:12px; color:#444444; }
div.wb-table-head-day-days	{ width:100%; height:27px; }
span.wb-table-head-day-li	{ display:block; float:left; width:21px; height:14px; padding:7px 5px 6px 0px; text-align:center; font-family:Arial, Helvetica, sans-serif; font-size:12px; color:#222222; }
/*-СПИСОК-*/
div.wb-table			{ width:1195px; height:22px; padding:1px 0px 1px 0px; background:#F7F7F7; border-bottom:#EEEEEE 1px solid; }
div.wb-table:hover		{ background:#EEEEEE; }
span.wb-table-li		{ display:block; float:left; height:14px; margin:4px 0px 4px 0px; border-right:#DDDDDD 1px solid; text-align:center; font-family:Tahoma, Geneva, sans-serif; font-size:11px; font-weight:bold; color:#778899; cursor:default; }
span.wb-table-day-li	{ display:block; position:relative; float:left; width:21px; height:22px; margin:0px 5px 0px 0px; }
span.wb-day-fin			{ background:url(my_template/img/wb_check_finish.png); }
span.wb-day-act			{ background:url(my_template/img/wb_check_active.png); }
span.wb-day-null		{ background:url(my_template/img/wb_check_future.png); }
div.wb-finish-learning	{ }
/*-ТУЛЛПИТ-*/
div.wb-tooltip			{ display:none; position:absolute; left:-245px; top:-100px; width:280px; height:100px; background:url(my_template/img/wb_tooltip.png); }
span.wb-tooltip-name	{ display:block; width:auto; height:14px; padding:13px 0px 12px 10px; font-family:Tahoma, Geneva, sans-serif; font-size:11px; font-weight:bold; color:#778899; }
span.wb-tooltip-date	{ display:block; width:auto; height:14px; padding:5px 0px 0px 10px; font-family:Tahoma, Geneva, sans-serif; font-size:12px; }
span.wb-tooltip-d-name	{ display:inline-block; width:140px; height:14px; color:#555555; }
span.wb-tooltip-d-value	{ display:inline-block; width:auto;  height:14px; color:#778899; }
/*-СПИСОК ПОДРАЗДЕЛЕНИЙ-*/
div.wb-sub-block		{ height:500px; float:left; background:#F9F9F9; border-left:#EEEEEE 1px solid; }
span.wb-sub-head		{ display:block; width:100%; height:auto; padding:5px 0px 5px 0px; border-bottom:#EEEEEE 1px solid; text-align:center; font-family:Tahoma, Geneva, sans-serif; font-size:12px; font-weight:bold; color:#555555; }
div.wb-sub-body			{ padding:10px 10px 10px 10px; }
a.wb-sub-li				{ display:block; float:left; width:30px; height:auto; margin:0; padding:4px 2px 4px 2px; font-family:Tahoma, Geneva, sans-serif; font-size:12px; color:#4682B4; text-decoration:none; overflow:hidden; }
a.wb-sub-li:hover		{ text-decoration:underline; }
div.wb-finish-learning		{ display:none; }
</style>

<%
CountWB = 21; //Количество дней для обучения.

//Проверяем, принадлежит ли текущий пользователь к группе контроллирующего персонала.

//group_supervisory_staff = tools_web.get_web_param( curParams, 'group_supervisory_staff', '', true );
//group_supervisory_staff = group_supervisory_staff.split(',');
//i_am_group_staff = false;
//for(g in group_supervisory_staff)
//{
//	if(Trim(g) == curUser.position_name) i_am_group_staff = true;
//}
//Если текущий пользователь в группе контроля и в урл есть переменная shop, показываем выбранный магазин.
//shop_name = curUser.position_parent_name;
//if(i_am_group_staff == true && Request.QueryString.HasProperty('shop'))
//{
//	shop_name = OpenDoc(UrlFromDocID(Int(Request.QueryString.shop))).TopElem.name; 
//}	
//shop_name = 'C1101';///////////////////////////////////////////////////

//Запрашиваем сотрудников магазина и курсы магазина.

_childShop = ArrayMerge(XQuery("for $elem in subdivisions where $elem/parent_object_id = 5717156742436487223 return $elem"),'id',',');
alert(_childShop);

_collaborators = XQuery("for $elem in collaborators where $elem/is_dismiss=false() return $elem");
alert(ArrayCount(_collaborators));

//_childCollaborator = ArrayIntersect(_collaborators, _childShop, 'position_parent_id', 'id');
//alert(ArrayCount(_childCollaborator));

//_queryLearningFinish = ArraySelectAll(XQuery("for $l in learnings where contains($l/course_name, 'Рабочая тетрадь') and ForeignElem($l/person_id)/is_dismiss!=true() and MatchSome(ForeignElem($l/person_id.TopElem.position_parent_name, (" + _childShop +")) order by ForeignElem($l/course_id)/code return $l"));



_queryLearningFinish = ArraySelectAll(XQuery("for $l in learnings where contains($l/course_name, 'Рабочая тетрадь') and ForeignElem($l/person_id)/is_dismiss!=true() and MatchSome(ForeignElem($l/person_id)/position_parent_id,("+ _childShop +")) order by ForeignElem($l/course_id)/code return $l"));
alert(ArrayCount(_queryLearningFinish));


_queryLearningActive = XQuery("for $l in active_learnings where contains($l/course_name, 'Рабочая тетрадь') and ForeignElem($l/person_id)/is_dismiss!=true() and MatchSome(ForeignElem($l/person_id)/position_parent_id,("+ _childShop +")) order by ForeignElem($l/course_id)/code return $l");
alert(ArrayCount(_queryLearningActive));
_queryLearningAll	 = ArrayUnion(_queryLearningFinish, _queryLearningActive);

// Создаем массив с сотрудниками магазина, которые имеют РТ
learning_persons = ArraySelectDistinct(ArrayExtractKeys(ArraySort(_queryLearningAll, 'person_fullname', '+'), 'person_id'));
learning_persons_object = new Array();
for(p in learning_persons)
{
	doc		 = OpenDoc(UrlFromDocID(p)).TopElem;
	fullname = doc.fullname;
	shop = doc.position_parent_name;
	position = doc.position_name;
	group	 = doc.custom_elems.ObtainChildByKey("din_groups").value
	learning_persons_object.push({id:p, fullname:fullname, shop:shop, position:position, group:group});

}
%>
<div class="wb-block">
	<div class="wb-head-line-a">
		
	</div>
	<div class="wb-head-line-b">
		<span class="wb-head-count">Количество сотрудников на обучении: <%=ArrayCount(_queryLearningActive);%></span>
		<a class="wb-head-view" id="wb_link_active">Показать всех</a> 
	
		<div class="customClear"></div>
	</div>
	<div class="wb-body">
		<div id="wb_now_shop">
		<%
			if(ArrayCount(_queryLearningAll)>0)
			{
			%>
				<div class="wb-table-head">
					<span class="wb-table-head-li" style="width:245px;">ФИО сотрудника</span>
					<span class="wb-table-head-li" style="width:60px;">Магазин</span>
					<span class="wb-table-head-li" style="width:130px;">Отдел</span>
					<span class="wb-table-head-li" style="width:130px;">Должность</span>
					<span class="wb-table-head-li-b">
						<div class="wb-table-head-day-head">Процесс обучения (по дням)</div>
						<div class="wb-table-head-day-days">
							<span class="wb-table-head-day-li">1</span>
							<span class="wb-table-head-day-li">2</span>
							<span class="wb-table-head-day-li">3</span>
							<span class="wb-table-head-day-li">4</span>
							<span class="wb-table-head-day-li">5</span>
							<span class="wb-table-head-day-li">6</span>
							<span class="wb-table-head-day-li">7</span>
							<span class="wb-table-head-day-li">8</span>
							<span class="wb-table-head-day-li">9</span>
							<span class="wb-table-head-day-li">10</span>
							<span class="wb-table-head-day-li">11</span>
							<span class="wb-table-head-day-li">12</span>
							<span class="wb-table-head-day-li">13</span>
							<span class="wb-table-head-day-li">14</span>
							<span class="wb-table-head-day-li">15</span>
							<span class="wb-table-head-day-li">16</span>
							<span class="wb-table-head-day-li">17</span>
							<span class="wb-table-head-day-li">18</span>
							<span class="wb-table-head-day-li">19</span>
							<span class="wb-table-head-day-li">20</span>
							<span class="wb-table-head-day-li">21</span>
							<div class="customClear"></div>
						</div>
					</span>
					<span class="wb-table-head-li" style="width:79px;">Кол-во дней</span>
					<div class="customClear"></div>
				</div>
				<%
				startDateCount = new Array();
				endDateCount = new Array();
				var startDate = '';
				var endDate = '';
				var diff = '';
				var isEnd = true;

				for(p in learning_persons_object)
				{

					personLearning = ArraySelectByKey(_queryLearningAll, p.id, 'person_id');
					personLearning = ArrayDirect(ArrayRange(personLearning, 0, 21));
					//Номер первого курса
					num_first_day_rt = Int(String(ArrayFirstElem(personLearning).course_id.ForeignElem.code).split('_')[2]);

					end_class = '';
					if(ArrayCount(personLearning)+num_first_day_rt-1 == 21)
					{
						end_l = personLearning[ArrayCount(personLearning)-1];
						if(end_l.state_id == 4)
						{
							end_class = ' wb-finish-learning';
						}
					}
					%>
					<div class="wb-table<%=end_class;%>">
						<span class="wb-table-li" style="width:235px; text-align:left; padding-left:10px;"><%=p.fullname;%></span>
						<span class="wb-table-li" style="width:50px; text-align:left; padding-left:10px;"><%=p.shop;%></span>
						<span class="wb-table-li" style="width:130px;"><%=p.group;%></span>
						<span class="wb-table-li" style="width:131px; border:0;"><%=p.position;%></span>
						<%

							//Если РТ начинается не с первого дня.
							if(num_first_day_rt != 1)
							{
								for(i=1; i<num_first_day_rt; i++)
								{
									%>
									<span class="wb-table-day-li wb-day-null"></span>
									<%
								}
							}

							for(l in personLearning)
							{
								%>
									<span class="wb-table-day-li <%if(l.state_id == 1){%>wb-day-act<%}else{%>wb-day-fin<%}%>" id="wb_day_<%=l.id;%>">
										<div class="wb-tooltip" id="t_wb_day_<%=l.id;%>">
											<span class="wb-tooltip-name"><%=l.course_id.ForeignElem.name;%></span>
											<span class="wb-tooltip-date">
												<span class="wb-tooltip-d-name">Начало обучения:</span>
												<span class="wb-tooltip-d-value"><% 
													Response.Write(String(l.start_usage_date).substr(0, 16));
													startDateCount.push({p.id : l.start_usage_date});
													%>
												</span>
											</span>
											<%
											if(l.state_id == 1) {
											isEnd = false;
											%>
											<span class="wb-tooltip-date">
												<span class="wb-tooltip-d-name">В процессе..</span>
											</span>
											<%
											}
											else {
											%>
											<span class="wb-tooltip-date">
												<span class="wb-tooltip-d-name">Завершение обучения:</span>
												<span class="wb-tooltip-d-value"><%=String(l.last_usage_date).substr(0, 16);%></span>
											</span>
											<%
											}
											%>
										</div>
									</span>
								<%

							}
							for(i=(ArrayCount(personLearning)+num_first_day_rt-1); i<CountWB; i++)
							{
								%>
								<span class="wb-table-day-li wb-day-null"></span>
								<%
							}
						%>
						<span class="wb-table-li" style="width:79px; border:0;">
						<% 

							startDate = ArrayDirect(XQuery("for $elem in _queryLerningAll where $elem/person_id = "+ p.id +" and orderBy $elem/code return $elem "));
							Response.Write(startDate[0]);
						%>
						</span>
						<div class="customClear"></div>
					</div>		
					<%
				}
			}
			else
			{
			%>
				<span class="wb-null-result">Сотрудников не найдено.</span>
			<%
			}
			%>
		</div>
		
	</div>
</div>